name: Sync Ansible Folder to ubunru/home

on:
  workflow_dispatch:

jobs:
  sync-ansible:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Sync ansible folder to controller
        run: |
          aws ssm send-command \
            --instance-ids ${{ secrets.ANSIBLE_CONTROLLER_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ubuntu",
              "rm -rf devops-bootcamp-final-project-kamariza",
              "git clone --filter=blob:none --sparse https://github.com/kamariza30/devops-bootcamp-final-project-kamariza.git",
              "cd devops-bootcamp-final-project-kamariza",
              "git sparse-checkout set ansible",
              "echo \"âœ“ Ansible folder synced successfully at $(date)\"",
              "ls -la"
            ]' \
            --region ap-southeast-1

      - name: Verify sync
        run: echo "Ansible playbooks synced to controller"
